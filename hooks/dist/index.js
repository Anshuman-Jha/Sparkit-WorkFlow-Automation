import express from "express";
import { PrismaClient } from "../src/generated/prisma/index.js";
const client = new PrismaClient();
const app = express();
app.use(express.json());
// This End Point is Basically Hook Generated by spark where we listen to Events
// Whenever Someone Hits This WebHook URL
app.post("/hooks/catch/:userId/:sparkId", async (req, res) => {
    const userId = req.params.userId;
    const sparkId = req.params.sparkId;
    const body = req.body;
    console.log("Reached here");
    console.log("Request body:", body);
    // Validate that body exists and is not empty
    if (!body || (typeof body === 'object' && Object.keys(body).length === 0)) {
        return res.status(400).json({ error: "Request body is required and cannot be empty" });
    }
    // Store in db a new spark run/ Trigger
    try {
        await client.$transaction(async (tx) => {
            console.log("Reached Transaction");
            const run = await tx.sparkRun.create({
                data: {
                    sparkId: sparkId,
                    metadata: body || {},
                }
            });
            await tx.sparkRunOutbox.create({
                data: {
                    sparkRunId: run.id,
                }
            });
            res.json({
                msg: run
            });
        });
    }
    catch (e) {
        console.error("DB error", e);
        res.status(500).json({ error: e.message });
    }
});
const port = 3001;
app.listen(port, () => {
    console.log(`Server listening on port ${port}`);
});
// Whenever we create a spark it gives us back webhook url
//   // Store in db a new trigger
// Push it on a queue(Kafka / Redis) => Asynchronous Backend
//# sourceMappingURL=index.js.map